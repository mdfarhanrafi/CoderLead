// --- API: Run Code (simplified) ---
// app/api/run-code/route.ts
import { NextResponse } from 'next/server';

export async function POST(req: Request) {
  const { code, language, testCases } = await req.json();

  const languageMap: Record<string, number> = { javascript: 63 }; // Node.js

  const results = await Promise.all(
    testCases.map(async (tc: { input: string; output: string }) => {
      const res = await fetch('https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=false&wait=true', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-RapidAPI-Key': process.env.RAPIDAPI_KEY || '',
          'X-RapidAPI-Host': 'judge0-ce.p.rapidapi.com',
        },
        body: JSON.stringify({
          source_code: code,
          language_id: languageMap[language],
          stdin: tc.input,
        }),
      });
      const data = await res.json();
      const passed = data.stdout?.trim() === tc.output.trim();
      return {
        input: tc.input,
        expected: tc.output,
        actual: data.stdout?.trim() || '',
        passed,
      };
    })
  );

  const allPassed = results.every(r => r.passed);
  return NextResponse.json({ passed: allPassed, details: results });
}
