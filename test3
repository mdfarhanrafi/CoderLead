// --- API: Submit Code ---
// app/api/submit-code/route.ts
import { db } from '@/lib/db';
import { submissions } from '@/drizzle/submissions';
import { userProgress } from '@/drizzle/user_progress';
import { NextResponse } from 'next/server';

export async function POST(req: Request) {
  const { userId, problemId, code, language, testCases } = await req.json();

  const runRes = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}/api/run-code`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code, language, testCases }),
  });
  const result = await runRes.json();

  const status = result.passed ? 'Accepted' : 'Wrong Answer';

  await db.insert(submissions).values({
    userId,
    problemId,
    code,
    language,
    status,
    output: result.details,
  });

  if (status === 'Accepted') {
    await db.insert(userProgress)
      .values({ userId, problemId, status: 'solved' })
      .onConflictDoUpdate({
        target: ['user_id', 'problem_id'],
        set: { status: 'solved', updatedAt: new Date() },
      });
  }

  return NextResponse.json({ status, result });
}